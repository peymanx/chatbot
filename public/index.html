<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ú†Øª Ø¨Ø§Øª â€” peyman-x</title>
<style>
:root {
  --bg-color: #121212;
  --text-color: #fff;
  --header-bg: #1f1f1f;
  --input-bg: #1f1f1f;
  --user-bg: #2e7d32;
  --bot-bg: #1565c0;
  --system-bg: #fff;
  --system-text: #222;
}

body {
  margin:0; padding:0;
  font-family:"Vazirmatn",Tahoma,sans-serif;
  background: var(--bg-color); color: var(--text-color);
  display:flex; flex-direction:column; height:100vh;
}

header{
  background: var(--header-bg);
  padding:15px; text-align:center;
  font-size:22px; font-weight:700;
  border-bottom:1px solid #333;
  display:flex; justify-content:space-between; align-items:center;
}

header button{
  background:#3a3a3a; border:none; border-radius:8px;
  color:#fff; padding:5px 10px; cursor:pointer; font-size:14px;
}
header button:hover{background:#555;}

/* Ù…Ø­ÛŒØ· Ú†Øª */
.chat-container{
  flex:1; display:flex; flex-direction:column-reverse;
  padding:15px;
  overflow-y:auto;
  gap:8px;
}

/* Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
.message{
  max-width:75%;
  padding:10px 15px;
  border-radius:20px;
  position:relative;
  word-wrap:break-word;
  line-height:1.5;
  opacity:0;
  transform: translateY(30px);
  transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.35s ease-out;
}

.message.show{
  opacity:1;
  transform: translateY(0);
}

.username{
  font-size:12px; font-weight:bold;
  margin-bottom:4px;
  display:block;
  opacity:0.8;
  color:#eee;
}

/* Ú©Ø§Ø±Ø¨Ø± Ø³Ø¨Ø² Ø±Ø§Ø³Øª */
.user{
  align-self:flex-end;
  background: var(--user-bg);
  color:white;
  border-bottom-right-radius:0;
}
.user::after{
  content:""; position:absolute;
  right:-8px; bottom:0;
  width:0;height:0;
  border-top:8px solid var(--user-bg);
  border-right:8px solid transparent;
}

/* Ø¨Ø§Øª Ø¢Ø¨ÛŒ Ú†Ù¾ */
.bot{
  align-self:flex-start;
  background: var(--bot-bg);
  color:white;
  border-bottom-left-radius:0;
}
.bot::after{
  content:""; position:absolute;
  left:-8px; bottom:0;
  width:0;height:0;
  border-top:8px solid var(--bot-bg);
  border-left:8px solid transparent;
}

/* Ø³ÛŒØ³ØªÙ… Ø³ÙÛŒØ¯ ÙˆØ³Ø· */
.system{
  align-self:center;
  background: var(--system-bg);
  color: var(--system-text);
  border-radius:12px;
  padding:8px 15px; font-weight:600;
  box-shadow:0 0 5px rgba(0,0,0,0.3);
  opacity:1; transform:translateY(0);
}

/* ÙˆØ±ÙˆØ¯ÛŒ */
.chat-input{
  display:flex; padding:12px; background: var(--input-bg); border-top:1px solid #333;
}
.chat-input input{
  flex:1; padding:10px 12px;
  border-radius:8px; border:none;
  background:#222; color:#fff; font-size:16px;
}
.chat-input input:focus{outline:none; box-shadow:0 0 5px #444;}
.chat-input button{
  margin-right:10px; padding:10px 20px;
  background:#3a3a3a; border:none; border-radius:8px;
  color:#fff; cursor:pointer; font-size:16px; font-weight:600;
}
.chat-input button:hover{background:#555;}
</style>
</head>
<body>
<header>
  Ú†Øª Ø¨Ø§Øª â€” peyman-x
  <button id="themeToggle">ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª</button>
</header>

<div class="chat-container" id="chat">
  <div class="message system">Ø¨Ù‡ Ú†Øªâ€ŒØ¨Ø§Øª peyman-x Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ğŸ‘‹</div>
</div>

<div class="chat-input">
  <input type="text" id="msg" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
  <button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>
</div>

<script>
const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const themeBtn = document.getElementById("themeToggle");

// ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
let history = [];
let historyIndex = -1;

// Ø­Ø§Ù„Øª Ø¯Ø§Ø±Ú©/Ù„Ø§ÛŒØª
let darkMode = true;
themeBtn.addEventListener("click", ()=>{
  darkMode = !darkMode;
  if(darkMode){
    document.documentElement.style.setProperty('--bg-color','#121212');
    document.documentElement.style.setProperty('--text-color','#fff');
    document.documentElement.style.setProperty('--header-bg','#1f1f1f');
    document.documentElement.style.setProperty('--input-bg','#1f1f1f');
    document.documentElement.style.setProperty('--user-bg','#2e7d32');
    document.documentElement.style.setProperty('--bot-bg','#1565c0');
    document.documentElement.style.setProperty('--system-bg','#fff');
    document.documentElement.style.setProperty('--system-text','#222');
  } else {
    document.documentElement.style.setProperty('--bg-color','#f5f5f5');
    document.documentElement.style.setProperty('--text-color','#222');
    document.documentElement.style.setProperty('--header-bg','#ddd');
    document.documentElement.style.setProperty('--input-bg','#eee');
    document.documentElement.style.setProperty('--user-bg','#43a047');
    document.documentElement.style.setProperty('--bot-bg','#1e88e5');
    document.documentElement.style.setProperty('--system-bg','#fff');
    document.documentElement.style.setProperty('--system-text','#222');
  }
});

// ØªØ§Ø¨Ø¹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…
function appendMessage(text, cls, username=""){
  const div = document.createElement("div");
  div.className = `message ${cls}`;
  
  if(username && cls!=="system"){
    const name = document.createElement("span");
    name.className="username";
    name.textContent=username;
    div.appendChild(name);
  }

  // Ø®Ø·ÙˆØ· Ø¬Ø¯ÛŒØ¯ (\n ÙˆØ§Ù‚Ø¹ÛŒ ÛŒØ§ \\n)
  text.replace(/\\n/g, "\n").split("\n").forEach((line, i, arr)=>{
    div.appendChild(document.createTextNode(line));
    if(i < arr.length - 1) div.appendChild(document.createElement("br"));
  });

  if(cls==="system"){
    chat.appendChild(div);
  } else {
    chat.prepend(div);
  }

  setTimeout(()=>{ if(cls!=="system") div.classList.add("show"); },50);
}

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
async function sendMessage(){
  const msg = msgInput.value.trim();
  if(!msg) return;

  history.unshift(msg);
  historyIndex = -1;

  appendMessage(msg,"user","Ø´Ù…Ø§");
  msgInput.value="";
  msgInput.focus();

  try{
    const res = await fetch("/api/chat",{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({user:"localuser",message:msg})
    });
    const data = await res.json();
    if(data.reply) appendMessage(data.reply,"bot","peyï»¿man-x");
    else appendMessage("Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.","bot","peyï»¿man-x");
  }catch{
    appendMessage("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.","bot","peyï»¿man-x");
  }
}

// Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡
msgInput.addEventListener("keydown", e=>{
  if(e.key==="ArrowUp"){
    e.preventDefault();
    if(history.length && historyIndex < history.length-1){
      historyIndex++;
      msgInput.value = history[historyIndex];
    }
  } else if(e.key==="ArrowDown"){
    e.preventDefault();
    if(historyIndex > 0){
      historyIndex--;
      msgInput.value = history[historyIndex];
    } else {
      historyIndex = -1;
      msgInput.value = "";
    }
  }
});

// Enter Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„
msgInput.addEventListener("keypress", e=>{
  if(e.key==='Enter') sendMessage();
});
</script>
</body>
</html>
